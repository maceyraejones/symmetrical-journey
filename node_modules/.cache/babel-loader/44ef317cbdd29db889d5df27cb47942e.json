{"ast":null,"code":"import { isSafari, isFramerX, isTest } from \"../../utils/environment.js\";\nimport { RenderTarget } from \"../types/RenderEnvironment.js\";\n/**\n * This file contains a bunch of helpers to force browser to render elements\n * with layer backing (GPU accelleration)\n */\n\n/**\n * The string in this smallValue is very specifically \"0.000001px\".\n *\n * - Safari before Catalina will change 1e-7 into 0.0000001px\n * - Safari in Catalina will change 0.0000001px into 1e-7\n *\n * So this value should be \"0.000001px\" (1e-6) and not smaller, because\n * otherwise it will break the string replacement for removing the translateZ\n * hack.\n */\n\nconst smallValue = \"0.000001px\";\nexport const translateZ = ` translateZ(${smallValue})`; // We only apply this hack on the canvas and in Safari or FramerX\n\nconst useTranslateZHack = isFramerX() || isSafari() || isTest();\n/**\n * Forces layer backing during rendering with a motion style\n */\n\nexport function forceLayerBackingWithMotionStyle(motionStyle) {\n  // This forces 3d acceleration on Chrome\n  motionStyle.willChange = \"transform\"; // We only want to use the translateZ hack on the canvas\n\n  const onCanvas = RenderTarget.current() === RenderTarget.canvas;\n\n  if (useTranslateZHack && onCanvas) {\n    motionStyle.translateZ = smallValue;\n  }\n}\n/**\n * Forces layer backing during rendering with React's CSS properties\n *\n * @internal\n */\n\nexport function forceLayerBackingWithCSSProperties(cssProperties) {\n  // This forces 3d acceleration on Chrome\n  cssProperties.willChange = \"transform\";\n  setTranslateZHack(cssProperties, true);\n}\n/**\n * Forces layer backing by changing the style of an HTML Element that is already\n * rendered to the DOM\n * @param element The HTML element to force the layer backing on\n * @param enabled Whether to enable forced layer backing. If `true` the styles\n * will be modified to force layer backing. If `false` those styles will be\n * removed from the element\n */\n\nexport function forceLayerBackingOnElement(element, enabled) {\n  if (enabled) {\n    const willChange = element.style.willChange || \"\";\n\n    if (willChange !== \"transform\") {\n      // This forces 3d acceleration on Chrome\n      element.style.willChange = \"transform\";\n    }\n  } else {\n    element.style.removeProperty(\"will-change\");\n  }\n\n  setTranslateZHack(element.style, enabled);\n}\n/**\n * Within Safari we can force gpu layers (avoid dumping them) by adding a small\n * translateZ value:\n * https://github.com/WebKit/webkit/blob/6ddbf54e861f9df5e0171422c32cc6173120f717/LayoutTests/compositing/layer-creation/compositing-policy.html#L23\n * So to prevent this memory heuristic to trigger, we also rig those layers with\n * a tiny translateZ property.\n */\n\nfunction setTranslateZHack(style, enabled) {\n  const onCanvas = RenderTarget.current() === RenderTarget.canvas;\n\n  if (!useTranslateZHack || !onCanvas) {\n    // We only want to use the translateZ hack in Safari and FramerX on the canvas\n    return;\n  }\n\n  const transform = style.transform || \"\";\n\n  if (enabled) {\n    const hasTranslateZ = transform.includes(translateZ);\n\n    if (!hasTranslateZ) {\n      style.transform = transform + translateZ;\n    }\n  } else {\n    style.transform = transform.replace(translateZ, \"\");\n  }\n}","map":{"version":3,"mappings":"AAEA,SAASA,QAAT,EAAmBC,SAAnB,EAA8BC,MAA9B,QAA4C,4BAA5C;AACA,SAASC,YAAT,QAA6B,+BAA7B;AAEA;;;;;AAKA;;;;;;;;;;;AAUA,MAAMC,UAAU,GAAG,YAAnB;AACA,OAAO,MAAMC,UAAU,GAAG,eAAeD,UAAU,GAA5C,C,CACP;;AACA,MAAME,iBAAiB,GAAGL,SAAS,MAAMD,QAAQ,EAAvB,IAA6BE,MAAM,EAA7D;AAEA;;;;AAGA,OAAM,SAAUK,gCAAV,CAA2CC,WAA3C,EAAmE;AACrE;AACAA,aAAW,CAACC,UAAZ,GAAyB,WAAzB,CAFqE,CAIrE;;AACA,QAAMC,QAAQ,GAAGP,YAAY,CAACQ,OAAb,OAA2BR,YAAY,CAACS,MAAzD;;AAEA,MAAIN,iBAAiB,IAAII,QAAzB,EAAmC;AAC/BF,eAAW,CAACH,UAAZ,GAAyBD,UAAzB;AACH;AACJ;AAED;;;;;;AAKA,OAAM,SAAUS,kCAAV,CAA6CC,aAA7C,EAAyE;AAC3E;AACAA,eAAa,CAACL,UAAd,GAA2B,WAA3B;AACAM,mBAAiB,CAACD,aAAD,EAAgB,IAAhB,CAAjB;AACH;AAED;;;;;;;;;AAQA,OAAM,SAAUE,0BAAV,CAAqCC,OAArC,EAA2DC,OAA3D,EAA2E;AAC7E,MAAIA,OAAJ,EAAa;AACT,UAAMT,UAAU,GAAGQ,OAAO,CAACE,KAAR,CAAcV,UAAd,IAA4B,EAA/C;;AACA,QAAIA,UAAU,KAAK,WAAnB,EAAgC;AAC5B;AACAQ,aAAO,CAACE,KAAR,CAAcV,UAAd,GAA2B,WAA3B;AACH;AACJ,GAND,MAMO;AACHQ,WAAO,CAACE,KAAR,CAAcC,cAAd,CAA6B,aAA7B;AACH;;AACDL,mBAAiB,CAACE,OAAO,CAACE,KAAT,EAAgBD,OAAhB,CAAjB;AACH;AAED;;;;;;;;AAQA,SAASH,iBAAT,CAA2BI,KAA3B,EAAuED,OAAvE,EAAuF;AACnF,QAAMR,QAAQ,GAAGP,YAAY,CAACQ,OAAb,OAA2BR,YAAY,CAACS,MAAzD;;AACA,MAAI,CAACN,iBAAD,IAAsB,CAACI,QAA3B,EAAqC;AACjC;AACA;AACH;;AACD,QAAMW,SAAS,GAAGF,KAAK,CAACE,SAAN,IAAmB,EAArC;;AACA,MAAIH,OAAJ,EAAa;AACT,UAAMI,aAAa,GAAGD,SAAS,CAACE,QAAV,CAAmBlB,UAAnB,CAAtB;;AACA,QAAI,CAACiB,aAAL,EAAoB;AAChBH,WAAK,CAACE,SAAN,GAAkBA,SAAS,GAAGhB,UAA9B;AACH;AACJ,GALD,MAKO;AACHc,SAAK,CAACE,SAAN,GAAkBA,SAAS,CAACG,OAAV,CAAkBnB,UAAlB,EAA8B,EAA9B,CAAlB;AACH;AACJ","names":["isSafari","isFramerX","isTest","RenderTarget","smallValue","translateZ","useTranslateZHack","forceLayerBackingWithMotionStyle","motionStyle","willChange","onCanvas","current","canvas","forceLayerBackingWithCSSProperties","cssProperties","setTranslateZHack","forceLayerBackingOnElement","element","enabled","style","removeProperty","transform","hasTranslateZ","includes","replace"],"sources":["../../../src/render/utils/setLayerBacked.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}